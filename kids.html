<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Kids Today</title>
        <style>
         body {
             font-family: "Gill Sans", Helvetica, Arial;
         }
         #current span {
             display: block;
             text-align: center;
             padding-bottom: 5px;
         }
         table {
             border-collapse: collapse;
             border: 3px solid purple;
         }
         th, td {
             border: 1px solid purple;
             padding: 5px 8px;
         }
         td.center {
             text-align: center;
         }
         #time {
             font-size: smaller;
             text-align: right;
             color: #666;
             padding-bottom: 3px;
         }
         .current_day_type {
             background: #ffcccc;
         }
         .free {
             font-style: italic;
             text-align: center;
             color: #aaa;
         }
        </style>
    </head>

    <body>
        <div id="time">
        </div>

        <div id="current">
        </div>

        <div id="schedule">
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th>Marney</th>
                        <th>Kevin</th>
                        <th class="all_col">All</th>
                        <th class="odd_col">Odd</th>
                        <th class="even_col">Even</th>
                    </tr>
                </thead>

                <tbody id="schedule_body">
                </tbody>
            </table>
        </div>

        <script>
         var schedule = [
             { "period": 1,
               "marn": "free",
               "kev": "Health",
               "short_start":"08:55",
               "short_end":"09:34",
               "long_start":"08:55",
               "long_end":"10:15"},
             { "period": 2,
               "marn": "Choir",
               "kev": "Engineering",
               "short_start":"09:39",
               "short_end":"10:18",
               "long_start":"08:55",
               "long_end":"10:15"},
             { "period": 3,
               "marn": "Comp Sci",
               "kev": "Choir",
               "short_start":"10:23",
               "short_end":"11:02",
               "long_start":"10:20",
               "long_end":"11:45"},
             { "period": 4,
               "marn": "Env Sci",
               "kev": "English",
               "short_start":"11:07",
               "short_end":"11:46",
               "long_start":"10:20",
               "long_end":"11:45"},
             { "marn": "STEP",
               "kev": "STEP",
               "short_start":"11:46",
               "short_end":"12:26",
               "long_start":"11:45",
               "long_end":"12:30"},
             { "period": 5,
               "marn": "English",
               "kev": "Precalc",
               "short_start":"12:34",
               "short_end":"13:13",
               "long_start":"12:38",
               "long_end":"14:00"},
             { "period": 6,
               "marn": "US Gov",
               "kev": "Chinese",
               "short_start":"13:18",
               "short_end":"13:57",
               "long_start":"12:38",
               "long_end":"14:00"},
             { "period": 7,
               "marn": "free",
               "kev": "Biology",
               "short_start":"14:02",
               "short_end":"14:41",
               "long_start":"14:05",
               "long_end":"15:25"},
             { "period": 8,
               "marn": "AP Art",
               "kev": "History",
               "short_start":"14:46",
               "short_end":"15:25",
               "long_start":"14:05",
               "long_end":"15:25"}
         ];
         var school_begins = "08:55";
         var school_ends = "15:25";

         var pad = function(num, len) { return ("00000000" + num).substr(-len) };
         var convertTo12Hour = function(timeString) {
             var parts = timeString.split(":");
             var hour = parseInt(parts[0]);

             if (hour > 12) {
                 hour = hour - 12;
             }
             return `${hour}:${parts[1]}`;
         }

         var drawScheduleTable = function() {
             var cell, text;
             var oddCell, evenCell;
             var tbody = document.getElementById('schedule_body');

             var now = getDate();
             var dayType;
             switch (now.getDay()) {
                 case 0:
                 case 6:
                     // weekend
                     dayType = 'weekend';
                     break;
                 case 1:
                     // Monday
                     dayType = 'full';
                     break;
                 case 2:
                 case 4:
                     // Tuesday or Thursday
                     dayType = 'odd';
                     break;
                 case 3:
                 case 5:
                     // Wednesday or Friday
                     dayType = 'even';
                     break;
             }

             for (i in schedule) {
                 var item = schedule[i];

                 var newRow = tbody.insertRow(tbody.rows.length);

                 cell = newRow.insertCell(0);
                 cell.className = "center";
                 text = document.createTextNode(item.period==undefined?"":item.period);
                 cell.appendChild(text);

                 cell = newRow.insertCell(1);
                 text = document.createTextNode(item.marn);
                 if (item.marn == "free") {
                     cell.className = "free";
                 }
                 cell.appendChild(text);

                 cell = newRow.insertCell(2);
                 text = document.createTextNode(item.kev);
                 cell.appendChild(text);

                 cell = newRow.insertCell(3);
                 if (dayType == "full")
                     cell.className = "current_day_type";
                 text = document.createTextNode(`${convertTo12Hour(item.short_start)} - ` +
                                                `${convertTo12Hour(item.short_end)}`);
                 cell.appendChild(text);

                 oddCell = newRow.insertCell(4);
                 evenCell = newRow.insertCell(5);
                 text = document.createTextNode(`${convertTo12Hour(item.long_start)} - ` +
                                                `${convertTo12Hour(item.long_end)}`);
                 if (item.period == undefined) {
                     // STEP
                     oddCell.appendChild(text);
                     var text2 = text.cloneNode()
                     evenCell.appendChild(text2);
                     if (dayType == "odd")
                         oddCell.className = "current_day_type";
                     if (dayType == "even")
                         evenCell.className = "current_day_type";
                 } else if (item.period % 2 == 1) {
                     oddCell.appendChild(text);
                     if (dayType == "odd")
                         oddCell.className = "current_day_type";
                 } else {
                     evenCell.appendChild(text);
                     if (dayType == "even")
                         evenCell.className = "current_day_type";
                 }
             }
         };

         var writeCurrentStatus = function(output) {
             document.getElementById("current").innerHTML = output;
         }


         var getDate = function() {
             var d = new Date();
             try {
                 // ?date=2018-08-21T13:09:00
                 var params = (new URL(document.location)).searchParams;
                 var dateParam = params.get("date");
                 if (dateParam !== null) {
                     d = new Date(dateParam);
                 }
             } catch (error) {
                 console.log("can't read params <iOS 11");
             }
             return d;
         };

         var whereAreTheyNow = function() {
             now = getDate();
             var h = pad(now.getHours(), 2);
             var m = pad(now.getMinutes(), 2);
             var current_time = `${h}:${m}`;

             if (current_time < school_begins || current_time > school_ends) {
                 writeCurrentStatus("<span>School is out</span>");
                 return;
             }

             var dayType;
             if (now.getDay() == 1) {
                 dayType = "short";
             } else if ([2,3,4,5].includes(now.getDay())) {
                 dayType = "long";
             } else {
                 dayType = "weekend";
             }

             if (dayType == "weekend") {
                 writeCurrentStatus("<span>It's the weekend, they're not in class</span>");
                 return;
             }

             var start_key = `${dayType}_start`;
             var end_key = `${dayType}_end`;
             for (var i in schedule) {
                 var period = schedule[i].period;
                 if (dayType == 'long' &&
                     (period % 2) == (now.getDay() % 2)) {
                     // get the right even/odd days
                     continue;
                 }
                 if (current_time >= schedule[i][start_key] &&
                     current_time <= schedule[i][end_key]) {
                     output = `<span id="marn">Marney is in ${schedule[i]['marn']}</span>` +
                              `<span id="kev">Kevin is in ${schedule[i]['kev']}</span>` +
                              `<span>until ${convertTo12Hour(schedule[i][end_key])}</span>`;
                     writeCurrentStatus(output);
                 }
             }
         };

         var showCurrentTime = function() {
             var options = {
                 weekday: 'short',
                 month: 'short',
                 day: 'numeric',
                 hour: 'numeric',
                 minute: 'numeric'
             };
             var now = getDate()
             document.getElementById("time").innerHTML = now.toLocaleDateString("en-US", options);
         };

         whereAreTheyNow();
         drawScheduleTable();
         showCurrentTime();
        </script>

    </body>
</html>
